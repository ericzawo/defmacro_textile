<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" >
  <head>
    <title>Querying s-expressions in Common Lisp</title>
    <meta name="description" content="An article about querying s-expressions in Common Lisp." />
    <link rel="stylesheet" type="text/css" href="../stylesheets/main.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../stylesheets/articles.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../stylesheets/print.css" media="print" />
    <link rel="alternate" type="application/rss+xml" title="defmacro.org" href="../rss/news.xml" />
    <link rel="home" href="../index.html" />
  </head>
  <body>
    <div id="wrapper"><div id="wrapper1"><div id="wrapper2"><div id="wrapper3">
      <div id="page-extra-1"><div id="page-extra-2"><div id="page-extra-3">&nbsp;</div></div></div>
      <div id="wrapper4">
	<div id="header">
	  <div id="header-extra-1">
	    <div id="header-extra-2">
	      <div id="header-extra-3">
		<div id="header-extra-4">
		  <div id="header-extra-5">
		    <a class="home" href="http://www.defmacro.org">Home - defmacro.org</a>
		    <span id="title">Made with alien technology.</span>
		    <div id="syndication"><a href="../rss/news.xml" title="RSS Feed"><img src="../images/xml.png" alt="RSS Feed" /></a></div>
		  </div>
		</div>
	      </div>
	    </div>
	  </div>
	</div>
	<div id="content">
	  <h1>Querying s-expressions in Common Lisp</h1>
	  <div class="date">Tuesday, April 1, 2008</div>
	  
	  <p>One downside of using Common Lisp to get things done is
	  that occasionally libraries taken for granted in other
	  languages are missing. I was using the excellent <a
	  href='http://common-lisp.net/project/s-xml/'>s-xml</a>
	  library to convert XML to s-expressions, when I realized
	  that Common Lisp has no library equivalent in functionality
	  to an implementation of XQuery.</p>
	  
	  <p>I needed to extract quite a bit of information from the
	  s-expressions I acquired. Using <em>car</em>, <em>cdr</em>,
	  <em>member</em>, and <em>find</em> quickly became
	  infeasible. I had to roll my own query mechanism. It took me
	  about twenty minutes to produce an acceptable <a
	  href='s-query.lisp'>solution</a>. It's only around 45 lines of
	  code.</p>

	  <p>The code is fairly specific to how I parse expressions
	  generated by <em>s-xml</em>. Its symbol handling needs to be
	  modified to fit more general needs. It's an interpreter, not
	  a compiler, so it's not as fast as it could be (though it's
	  fast enough for me, and I deal with quite a bit of
	  data). However, it's a good starting point, and an excellent
	  demonstration of Lisp's expressive power.</p>

	  <p>Consider the following s-expression:</p>
<pre class="source-code">
(setf expr
      '(foo
        (bar baz 1
         (bak 1)
         (bam 2)
	 (bat 3))))
</pre>
          <p>Normally, we'd have to write specialized Lisp code to
          obtain parts we're interested in. We can now query it
          directly:</p>
<pre class="source-code">
(s-query expr '(bar))
=> ((bar baz 1 (bak 1) (bam 2) (bat 3)))

(s-query expr '(bar bam))
=> ((bam 2))
</pre>
          <p>We can also handle querying attributes (by using
          keywords) and element contents (represented by last element
          and queried by using a tilde):</p>
<pre class="source-code">
(s-query expr '(bar :baz))
=> (1)

(s-query expr '(bar bam ~))
=> (2)
</pre>
          <p>What we've done so far is useful, but isn't terribly
          interesting. We provided the query engine with a full path
          and retrieved the results. In practice things often get more
          complicated. The query system also supports wildcards via a
          star selector, and a choice via a list of elements:</p>
<pre class="source-code">
(s-query expr '(bar *))
=> ((bak 1) (bam 2) (bat 3))

(s-query expr '(bar (bak bat)))
=> ((bak 1) (bat 3))
</pre>
          <p>We can, of course, continue querying heterogeneous
          results above for common elements:</p>
<pre class="source-code">
(s-query expr '(bar (bak bat) ~))
=> (1 3)
</pre>
          <p>Under 50 lines of code, implemented in possibly less time
          than it takes to install and understand a library, this is
          pretty impressive. If I find the time I'll make the code
          more extensible and robust, convert it to a compiler, and
          release it as an ASDF-Installable library. In the meantime,
          I hope people find it useful in it's current form.</p>
	  
	  <h2><a id="comments">Comments?</a></h2> <p class="first">If
	  you have any questions, comments, or suggestions, please
	  drop a note at <a
	  href="mailto:coffeemug@gmail.com">coffeemug@gmail.com</a>.
	  I'll be glad to hear your feedback.</p>
	</div>
      </div>
      <div id="page-extra-4"><div id="page-extra-5"><div id="page-extra-6">&nbsp;</div></div></div>
    </div></div></div>
    <div id="footer">
      <p>Everything on this site is in public domain unless stated otherwise.<br/>
      Contact me with any questions or comments at <a href="mailto:coffeemug@gmail.com">coffeemug@gmail.com</a>.</p>
      <img src="../images/valid-xhtml11.png" alt="Valid XHTML 1.1" />
      <img src="../images/valid-css.png" alt="Valid CSS" />
      <img src="../images/valid-rss.png" alt="Valid RSS" />
    </div>
  </div>
</body>
</html>
